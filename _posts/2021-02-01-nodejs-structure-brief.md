---
layout: post
title: NodeJS入门基础与线程模型
date: 2021-02-01 21:45:27.000000000 +08:00
---

> NodeJS作为一钟广泛使用的服务端运行环境，拥有大量的应用场景。NodeJS设计简单，并兼备高性能, 其设计思想具有很大借鉴意义，本文将介绍NodeJS涉及原理，科普相关知识。

## 前言

NodeJs在不引入其他线程的情况下，可以实现高并发，尤其适用高IO场景。并兼容JavaScript, 前端工程师可快速上手，提供后端服务能力。

## NodeJS的诞生

说到Nodejs，那就得先从[Ryan Dahl](https://en.wikipedia.org/wiki/Ryan_Dahl)讲起了。他一开始从事的工作是使用C++构建高性能的Web服务。但是由于C++更偏于底层，所以使用C++实现Web服务太过于繁琐，也很痛苦。

因此他就想能否使用一种简单的高级语言就可以实现Web服务呢？经过几番对比，最后`Ryan Dahl`选择了`JavaScript`, 当时前端技术蓬勃兴起，并且JS上手简单，并JS本身就是异步IO，能很好的支持Web服务。那么，如何降JS运行在服务端的环境呢？但是Google已经推出了`JavaScript`的C++解析引擎`V8`, 并拥有不错的性能表现，因此顺利成章的成为了NodeJS的组成部分。

NodeJS由于设计巧妙，开发简单，迅速收到开发者的喜爱，迅速得到了大公司的注意，`Joyent`和`Microsoft`都给NodeJS提供帮助，因此NodeJS迅速发展壮大。截止到目前，NodeJS的最新版本已经发展到V14/V15。成为广大开发者尤其是前端开发人员的快速、高性能后端服务的首选运行环境。

## NodeJS的体系结构

在介绍NodeJS体系架构前，我们先来明确NodeJS里的几个概念:

* 同步/异步
  
  同步/异步是用户态操作。同步就是函数在调用后，一只等待直到结果返回。异步那么就是调用后不需要等待结果返回，即可继续执行下一个函数，那么异步的结果会通过状态、回调触发返回，从而被获得到。

* 阻塞/非阻塞
  
  阻塞/非阻塞是内核态操作。阻塞是指操作在等待数据返回之前，当前执行线程会被挂起直到数据返回，这时线程理论上一直被这个操作所占用。非阻塞是指操作不会等待数据返回，但是会向内核注册一个通知或Hook，线程继续执行其他操作，待数据返回时，注册的通知会自动触发继续执行原来的操作。

* 事件驱动:
  
  事件驱动是一种操作触发方式，是异步动作的一种实现方式。比如鼠标左键点击，就可以看做一个事件。

有了以上的概念后，我们看一下NodeJS的整体架构图:

![NodeJS架构](/images/nodejs/node-1.png)

我们可以从架构图中看到，NodeJS由运行环境几大部分组成。

* Application: 上层的应用JS代码
* V8: 用于加载、解析JS的代码。
* Bindings: 是V8引擎和下层C++内置库、第三方库交互的桥梁，这层会对V8中的JS数据结构和操作进行转换成底层C++对应模块的调用。
* LibUV: 负责底层OS文件系统、网络系统、进程等的异步事件触发和回调。例如, Native I/O、Network I/O、Signal、Timer、Process、Pipe、Pool。

### V8引擎

NodeJS引入了V8引擎，使其可以快速解析并执行JS语言，在对V8引擎做了适当的修改后，作为NodeJS的基础组件。

### Bindings layer

### Libuv

